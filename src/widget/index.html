<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autolevel Widget</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        #debug-console {
            width: 100%;
            height: 150px;
            background: #222;
            color: #0f0;
            font-family: monospace;
            font-size: 10px;
            overflow-y: scroll;
            border: 1px solid #444;
            margin-top: 10px;
            padding: 5px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <i class="fa fa-spinner fa-spin"></i>
        <span>Loading...</span>
    </div>
    <div class="header-bar">
        <div class="main-tabs">
            <button id="tab-btn-autolevel" class="main-tab active"
                onclick="switchMainTab('autolevel')">Compensation</button>
            <button id="tab-btn-probing" class="main-tab" onclick="switchMainTab('probing')">Probing</button>
        </div>
        <span id="saved-msg" class="saved-msg">Saved <i class="fa fa-check"></i></span>
        <button class="btn-icon" id="btnGlobalSettings" onclick="toggleGlobalSettings()" title="Global Settings">
            <i class="fa fa-cog"></i>
        </button>
    </div>

    <!-- Global Settings Panel -->
    <div id="globalSettings" class="global-settings" style="display: none;">
        <div class="settings-group">
            <h5>Compensation / Surface Map</h5>
            <div class="settings-grid">
                <label><span data-tooltip="Z travel height between points">Height (H) <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="height"
                        value="2"></label>
                <label><span data-tooltip="Edge offset for mesh grid">Margin (M) <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="margin"
                        value="2.5"></label>
                <label><span data-tooltip="Number of X/Y grid points">Grid Size <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="grid"
                        value="3" min="2"></label>
            </div>
        </div>
        <div class="settings-group">
            <h5>Probing</h5>
            <div class="settings-grid">
                <label><span data-tooltip="Diameter of probe tip/shank">Probe Dia <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="probeDia"
                        value="6.00"></label>
                <label><span data-tooltip="Approx. workpiece Width (X)">Stock X <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="sizeX"
                        value="50"></label>
                <label><span data-tooltip="Approx. workpiece Depth (Y)">Stock Y <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="sizeY"
                        value="50"></label>
                <label><span data-tooltip="Probe trigger overshoot offset">Deflection <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number"
                        id="probeDeflection" value="0.36"></label>
                <label><span data-tooltip="Retract distance after touch">Retract <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="retract"
                        value="5"></label>
                <label><span data-tooltip="Max probe distance limit">Max Travel <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="maxTravel"
                        value="25"></label>
                <label><span data-tooltip="Safe height for rapids">Safe Z <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="safeZ"
                        value="20"></label>
                <label><span data-tooltip="Fine probing feedrate">Slow Feed <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="feedSlow"
                        value="50"></label>
                <label><span data-tooltip="Initial probing feedrate">Fast Feed <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="feedFast"
                        value="200"></label>
                <label><span data-tooltip="Touch plate Z-height param">Plate Thick. <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number"
                        id="plateThickness" value="15"></label>
                <label><span data-tooltip="X offset for skew measurement">Skew Spacing <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number"
                        id="probeSpacing" value="50"></label>
                <label><span data-tooltip="Plunge depth for corner probing">Corner Depth <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="probeDepth"
                        value="5.00"></label>
            </div>
        </div>
        <div class="settings-group">
            <div
                style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 3px; margin-bottom: 5px;">
                <h5 style="border: none; margin: 0; padding: 0;">Tool Change</h5>
                <label class="switch" title="Show/Hide Tool Change Button">
                    <input type="checkbox" id="showToolChange" checked>
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="settings-grid">
                <label><span data-tooltip="Machine X coordinate of tool probe">Tool Probe X <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="toolProbeX"
                        value="618.5"></label>
                <label><span data-tooltip="Machine Y coordinate of tool probe">Tool Probe Y <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="toolProbeY"
                        value="25"></label>
                <label><span data-tooltip="Machine Z height to approach probe">Tool Probe Z <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="toolProbeZ"
                        value="0"></label>
                <label><span data-tooltip="Machine Z safe travel height">Safe Z (Mach) <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number"
                        id="safeZMachine" value="0"></label>
                <label><span data-tooltip="Rapid travel speed (G0 replaced by G1 with this speed)">Travel Speed <i
                            class="fa fa-question-circle tooltip-icon"></i></span> <input type="number" id="travelSpeed"
                        value="500"></label>
            </div>
        </div>
    </div>

    <!-- Autolevel Tab Content -->
    <div id="main-tab-autolevel" class="main-tab-content active">
        <div class="widget-container">
            <!-- Skew Compensation Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3>Skew Compensation</h3>
                    <div id="skew-status" class="skew-status" style="display: none;">Skew: <span
                            id="skew-val">0.000</span>&deg;</div>
                </div>
                <!-- Buttons -->
                <div class="btn-row">
                    <button id="btn-measure-skew" class="btn btn-secondary btn-expand" onclick="run('skew')"><i
                            class="fa fa-random"></i> Measure Skew</button>
                    <button id="btn-clear-skew" class="btn btn-danger" title="Clear Skew"><i
                            class="fa fa-ban"></i></button>
                    <button id="btn-apply-skew" class="btn btn-secondary btn-expand" title="Apply Skew Only"><i
                            class="fa fa-check"></i> Apply Skew</button>
                </div>
                <div id="skew-locked-msg" class="skew-msg" style="display: none;">
                    <i class="fa fa-lock"></i> Skew already applied to file.
                </div>
            </div>

            <!-- Surface Map Panel -->
            <div class="panel visualizer-panel">
                <div class="panel-header">
                    <h3>Surface Map / Visualizer</h3>
                </div>
                <!-- Controls moved here -->
                <div class="btn-row" style="margin-bottom: 10px;">
                    <div id="autolevel-wrapper" style="display: flex; flex: 1; overflow: visible; position: relative;">
                        <button id="btn-autolevel" class="btn btn-primary" style="width: 100%;"><i
                                class="fa fa-map-o"></i>
                            Probe New Mesh</button>
                    </div>
                    <button id="btn-clear-mesh" class="btn btn-danger" title="Clear Mesh Data"><i
                            class="fa fa-ban"></i></button>
                    <button id="btn-apply-mesh" class="btn btn-secondary btn-expand"
                        title="Apply Surface Map to G-code"><i class="fa fa-check"></i> Apply Mesh</button>
                </div>

                <div id="visualizer-container"></div>
                <div id="status-text">No mesh data.</div>
            </div>
        </div>
    </div>

    <!-- Probing Tab Content -->
    <div id="main-tab-probing" class="main-tab-content" style="display: none;">
        <!-- Probing Tab Content -->
        <div id="main-tab-probing" class="main-tab-content" style="display: none;">
            <!-- Help Content (Hidden Templates for Modals) -->
            <div id="modal-templates" style="display: none;">
                <div id="tab-corner" class="tab-content">
                    <img src="img/instruction corner.png" alt="Corner Probe Placement" class="instruction-img">
                    <div>Position above the corner, within Max Travel distance.</div>
                </div>
                <div id="tab-block" class="tab-content">
                    <img src="img/instruction boss.png" alt="Block Probe Placement" class="instruction-img">
                    <div>Position outside the block: Left side (for X) or Front side (for Y).</div>
                </div>
                <div id="tab-hole" class="tab-content">
                    <img src="img/instruction hole.png" alt="Hole Probe Placement" class="instruction-img">
                    <div>Position inside the hole, approximately centered.</div>
                </div>
                <div id="tab-edge" class="tab-content">
                    <img src="img/instruction side.png" alt="Edge Probe Placement" class="instruction-img">
                    <div>Position outside the stock, facing the target edge.</div>
                </div>
                <div id="tab-touchplate" class="tab-content">
                    <img src="img/instruction touchplate.png" alt="Touchplate Probe Placement" class="instruction-img">
                    <div>Position directly above the touchplate surface.</div>
                </div>
                <div id="tab-surface" class="tab-content">
                    <img src="img/instruction corner.png" alt="Workpiece Surface Probe Placement"
                        class="instruction-img">
                    <div>Position directly above the workpiece surface.</div>
                </div>
                <div id="tab-skew" class="tab-content">
                    <img src="img/instruction side.png" alt="Skew Probe" class="instruction-img">
                    <div>Position probe at the left-most point of the front edge. The machine will probe Y, move X+, and
                        probe Y again to calculate angle.</div>
                </div>
                <div id="tab-tool-change" class="tab-content">
                    <img src="img/change tool.png" alt="Tool Change" class="instruction-img">
                    <div style="text-align: left; display: inline-block;">
                        <strong>Tool Change Sequence</strong><br>
                        1. Moves to Tool Probe Location.<br>
                        2. Probes CURRENT tool length.<br>
                        3. Pauses for manual tool change.<br>
                        4. Probes NEW tool length.<br>
                        5. Updates Z offset to match original tool.<br>
                        <br>
                        <strong style="color: #d9534f;">WARNING: Ensure tool setter is in place!</strong>
                    </div>
                </div>
            </div>
            <div id="tab-clear-skew-confirm" class="tab-content">
                <i class="fa fa-ban" style="font-size: 64px; margin: 20px; color: #d9534f;"></i>
                <div><strong>Clear Skew?</strong></div>
                <div style="margin: 15px 0;">This will reset the measured skew angle to
                    0&deg;.<br><br><strong>Note:</strong> If you have already applied skew to your G-code, you must
                    reload the file to remove it.</div>
            </div>

            <div id="tab-skew-result" class="tab-content">
                <i class="fa fa-balance-scale" style="font-size: 64px; margin: 20px; color: #555;"></i>
                <div><strong>Measurement Complete</strong></div>
                <div style="margin: 15px 0; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 4px;">
                    <div><strong>P1:</strong> <span id="skew-p1"></span></div>
                    <div><strong>P2:</strong> <span id="skew-p2"></span></div>
                    <div style="margin-top: 5px; font-size: 1.1em; color: #337ab7;"><strong>Angle:</strong> <span
                            id="skew-angle"></span>&deg;</div>
                </div>
                <div>Apply this skew angle to your loaded G-code?</div>
            </div>

            <div id="tab-apply-mesh-confirm" class="tab-content">
                <i class="fa fa-check-square-o" style="font-size: 64px; margin: 20px; color: #555;"></i>
                <div><strong>Probe Complete</strong></div>
                <div style="margin: 15px 0;"> Surface mesh generated successfully.<br><br>Do you want to apply this
                    compensation to your currently loaded G-code?</div>
            </div>

            <div id="tab-autolevel-confirm" class="tab-content">
                <img src="img/instruction corner.png" alt="Surface Map Probe" class="instruction-img">
                <div>Position the probe above the front-left corner of the mapping area. The machine will probe
                    the surface according to your "Probing" settings.<br><br></div>
                <div><strong>Start Surface Mapping?</strong><br><strong>Warning:</strong> This will delete any existing
                    mesh data.</div>
            </div>
            <div id="tab-apply-skew-manual" class="tab-content">
                <i class="fa fa-random" style="font-size: 64px; margin: 20px; color: #555;"></i>
                <div><strong>Apply Skew?</strong></div>
                <div style="margin: 15px 0;">Apply current skew settings to the loaded G-code?</div>
            </div>
            <div id="tab-apply-mesh-manual" class="tab-content">
                <i class="fa fa-map-o" style="font-size: 64px; margin: 20px; color: #555;"></i>
                <div><strong>Apply Surface Map?</strong></div>
                <div style="margin: 15px 0;">Apply current surface mesh to the loaded G-code?</div>
            </div>
            <div id="tab-clear-mesh-confirm" class="tab-content">
                <i class="fa fa-ban" style="font-size: 64px; margin: 20px; color: #d9534f;"></i>
                <div><strong>Clear Mesh Data?</strong></div>
                <div style="margin: 15px 0;">Are you sure you want to delete the current surface
                    mesh?<br><br><strong>Note:</strong> If you have already applied the mesh to your
                    G-code, you must reload the file to remove it.</div>
            </div>


        </div>

        <!-- Settings moved to Global Panel -->

        <!-- Confirmation Modal -->
        <div class="modal-overlay" id="confirmModal">
            <div class="modal-dialog">
                <div class="modal-header">Confirm Probe</div>
                <div class="modal-body" id="confirmBody">
                    <!-- Content injected by JS -->
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal()">Cancel</button>
                    <button class="modal-btn primary" id="btnConfirmRun">Run Probe</button>
                </div>
            </div>
        </div>

        <!-- Probe Action Buttons -->
        <div class="probe-grid">
            <button disabled onclick="run('corner', 'TL')"><span class="icon">┌</span></button>
            <button disabled onclick="run('edge', 'Y+')"><span class="icon">T</span></button>
            <button disabled onclick="run('corner', 'TR')"><span class="icon">┐</span></button>
            <button disabled class="btn-shape" onclick="run('z_touchplate')"><i class="fa fa-arrow-down"></i> Z
                Touchplate</button>

            <button disabled onclick="run('edge', 'X-')"><span class="icon">├</span></button>
            <button disabled class="btn-center" onclick="run('surface', 'Z')">Z</button>
            <button disabled onclick="run('edge', 'X+')"><span class="icon">┤</span></button>
            <button disabled class="btn-shape" onclick="run('boss', 'square')"><i class="fa fa-square-o"></i>
                Block</button>

            <button disabled onclick="run('corner', 'BL')"><span class="icon">└</span></button>
            <button disabled onclick="run('edge', 'Y-')"><span class="icon">┴</span></button>
            <button disabled onclick="run('corner', 'BR')"><span class="icon">┘</span></button>
            <button disabled class="btn-shape" onclick="run('pocket', 'circle')"><i class="fa fa-circle-o"></i>
                Hole</button>
            <button disabled class="btn-shape" onclick="run('tool_change')" style="grid-column: span 4;"><i
                    class="fa fa-exchange"></i>
                Tool Change</button>
        </div>
    </div>

    <!-- Libraries -->
    <script src="vis-graph3d.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="gcode-generator.js"></script>
    <script src="modal-manager.js"></script>
    <script src="index.js"></script>
</body>

</html>
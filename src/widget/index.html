<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autolevel Widget</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        #debug-console {
            width: 100%;
            height: 150px;
            background: #222;
            color: #0f0;
            font-family: monospace;
            font-size: 10px;
            overflow-y: scroll;
            border: 1px solid #444;
            margin-top: 10px;
            padding: 5px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <div class="header-bar">
        <div class="main-tabs">
            <button id="tab-btn-autolevel" class="main-tab active"
                onclick="switchMainTab('autolevel')">Compensation</button>
            <button id="tab-btn-probing" class="main-tab" onclick="switchMainTab('probing')">Probing</button>
        </div>
        <button class="btn-icon" id="btnGlobalSettings" onclick="toggleGlobalSettings()" title="Global Settings">
            <i class="fa fa-cog"></i>
        </button>
    </div>

    <!-- Global Settings Panel -->
    <div id="globalSettings" class="global-settings" style="display: none;">
        <div class="settings-group">
            <h5>Compensation / Surface Map</h5>
            <div class="settings-grid">
                <label><span>Height (H) <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Z travel height between points"></i></span> <input type="number" id="height"
                        value="2"></label>
                <label><span>Margin (M) <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Edge offset for mesh grid"></i></span> <input type="number" id="margin"
                        value="2.5"></label>
                <label><span>Grid Size <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Number of X/Y grid points"></i></span> <input type="number" id="grid"
                        value="3" min="2"></label>
            </div>
        </div>
        <div class="settings-group">
            <h5>Probing</h5>
            <div class="settings-grid">
                <label><span>Probe Dia <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Diameter of probe tip/shank"></i></span> <input type="number" id="probeDia"
                        value="6.00"></label>
                <label><span>Stock X <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Approx. workpiece Width (X)"></i></span> <input type="number" id="sizeX"
                        value="50"></label>
                <label><span>Stock Y <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Approx. workpiece Depth (Y)"></i></span> <input type="number" id="sizeY"
                        value="50"></label>
                <label><span>Deflection <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Probe trigger overshoot offset"></i></span> <input type="number"
                        id="probeDeflection" value="0.36"></label>
                <label><span>Retract <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Retract distance after touch"></i></span> <input type="number" id="retract"
                        value="5"></label>
                <label><span>Max Travel <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Max probe distance limit"></i></span> <input type="number" id="maxTravel"
                        value="25"></label>
                <label><span>Safe Z <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Safe height for rapids"></i></span> <input type="number" id="safeZ"
                        value="20"></label>
                <label><span>Slow Feed <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Fine probing feedrate"></i></span> <input type="number" id="feedSlow"
                        value="50"></label>
                <label><span>Fast Feed <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Initial probing feedrate"></i></span> <input type="number" id="feedFast"
                        value="200"></label>
                <label><span>Plate Thick. <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Touch plate Z-height param"></i></span> <input type="number"
                        id="plateThickness" value="15"></label>
                <label><span>Skew Spacing <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="X offset for skew measurement"></i></span> <input type="number"
                        id="probeSpacing" value="50"></label>
                <label><span>Corner Depth <i class="fa fa-question-circle tooltip-icon"
                            data-tooltip="Plunge depth for corner probing"></i></span> <input type="number"
                        id="probeDepth" value="5.00"></label>
            </div>
        </div>
    </div>

    <!-- Autolevel Tab Content -->
    <div id="main-tab-autolevel" class="main-tab-content active">
        <div class="widget-container">
            <!-- Settings moved to Global Panel -->

            <div class="panel actions-panel">
                <button id="btn-measure-skew" class="btn btn-secondary btn-action-lg" onclick="run('skew')"><i
                        class="fa fa-random"></i> Measure Skew (Y)</button>
                <button id="btn-autolevel" class="btn btn-primary btn-action-lg"><i class="fa fa-map-o"></i> Initiate
                    Surface Map</button>
                <button id="btn-reapply" class="btn btn-secondary btn-action-lg"><i class="fa fa-check-circle"></i>
                    Apply
                    Compensation</button>
            </div>

            <div class="panel visualizer-panel">
                <div class="panel-header">
                    <h3>Mesh Visualizer</h3>
                    <div id="skew-status" class="skew-status" style="display: none;">Skew: <span
                            id="skew-val">0.000</span>&deg;</div>
                </div>
                <div id="visualizer-container"></div>
                <div id="status-text">No mesh data.</div>
            </div>
        </div>
    </div>

    <!-- Probing Tab Content -->
    <div id="main-tab-probing" class="main-tab-content" style="display: none;">
        <!-- Probing Tab Content -->
        <div id="main-tab-probing" class="main-tab-content" style="display: none;">
            <!-- Help Content (Hidden Templates for Modals) -->
            <div id="modal-templates" style="display: none;">
                <div id="tab-corner" class="tab-content">
                    <img src="img/instruction corner.png" alt="Corner Probe Placement" class="instruction-img">
                    <div>Position above the corner, within Max Travel distance.</div>
                </div>
                <div id="tab-block" class="tab-content">
                    <img src="img/instruction boss.png" alt="Block Probe Placement" class="instruction-img">
                    <div>Position outside the block: Left side (for X) or Front side (for Y).</div>
                </div>
                <div id="tab-hole" class="tab-content">
                    <img src="img/instruction hole.png" alt="Hole Probe Placement" class="instruction-img">
                    <div>Position inside the hole, approximately centered.</div>
                </div>
                <div id="tab-edge" class="tab-content">
                    <img src="img/instruction side.png" alt="Edge Probe Placement" class="instruction-img">
                    <div>Position outside the stock, facing the target edge.</div>
                </div>
                <div id="tab-touchplate" class="tab-content">
                    <img src="img/instruction touchplate.png" alt="Touchplate Probe Placement" class="instruction-img">
                    <div>Position directly above the touchplate surface.</div>
                </div>
                <div id="tab-surface" class="tab-content">
                    <img src="img/instruction corner.png" alt="Workpiece Surface Probe Placement"
                        class="instruction-img">
                    <div>Position directly above the workpiece surface.</div>
                </div>
                <div id="tab-skew" class="tab-content">
                    <img src="img/instruction side.png" alt="Skew Probe" class="instruction-img">
                    <div>Position probe at the left-most point of the front edge. The machine will probe Y, move X+, and
                        probe Y again to calculate angle.</div>
                </div>
            </div>
            <div id="tab-skew-result" class="tab-content">
                <i class="fa fa-balance-scale" style="font-size: 64px; margin: 20px; color: #555;"></i>
                <div><strong>Skew Measurement Complete</strong></div>
                <div style="margin: 15px 0; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 4px;">
                    <div><strong>P1:</strong> <span id="skew-p1"></span></div>
                    <div><strong>P2:</strong> <span id="skew-p2"></span></div>
                    <div style="margin-top: 5px; font-size: 1.1em; color: #337ab7;"><strong>Angle:</strong> <span
                            id="skew-angle"></span>&deg;</div>
                </div>
                <div>Apply this compensation to future moves?</div>
            </div>
            <div id="tab-apply-mesh-confirm" class="tab-content">
                <i class="fa fa-check-square-o" style="font-size: 64px; margin: 20px; color: #555;"></i>
                <div><strong>Surface Mapping Complete</strong></div>
                <div style="margin: 15px 0;"> The surface mesh has been generated. <br>Apply this compensation to the
                    loaded G-code?</div>
            </div>
            <div id="tab-autolevel-confirm" class="tab-content">
                <i class="fa fa-th" style="font-size: 64px; margin: 20px; color: #555;"></i>
                <div><strong>Initiate Surface Mapping?</strong><br>This will clear the current mesh and probe the
                    surface
                    based on your settings.</div>
            </div>
            <div id="tab-reapply-confirm" class="tab-content">
                <i class="fa fa-refresh" style="font-size: 64px; margin: 20px; color: #555;"></i>
                <div><strong>Reapply Compensation?</strong><br>This will re-process the loaded G-code using the existing
                    mesh and skew data.</div>
            </div>
        </div>

        <!-- Settings moved to Global Panel -->

        <!-- Confirmation Modal -->
        <div class="modal-overlay" id="confirmModal">
            <div class="modal-dialog">
                <div class="modal-header">Confirm Probe</div>
                <div class="modal-body" id="confirmBody">
                    <!-- Content injected by JS -->
                </div>
                <div class="modal-footer">
                    <button class="modal-btn" onclick="closeModal()">Cancel</button>
                    <button class="modal-btn primary" id="btnConfirmRun">Run Probe</button>
                </div>
            </div>
        </div>

        <!-- Probe Action Buttons -->
        <div class="probe-grid">
            <button disabled onclick="run('corner', 'TL')"><span class="icon">┌</span></button>
            <button disabled onclick="run('edge', 'Y+')"><span class="icon">T</span></button>
            <button disabled onclick="run('corner', 'TR')"><span class="icon">┐</span></button>
            <button disabled class="btn-shape" onclick="run('z_touchplate')"><i class="fa fa-arrow-down"></i> Z
                Touchplate</button>

            <button disabled onclick="run('edge', 'X-')"><span class="icon">├</span></button>
            <button disabled class="btn-center" onclick="run('surface', 'Z')">Z</button>
            <button disabled onclick="run('edge', 'X+')"><span class="icon">┤</span></button>
            <button disabled class="btn-shape" onclick="run('boss', 'square')"><i class="fa fa-square-o"></i>
                Block</button>

            <button disabled onclick="run('corner', 'BL')"><span class="icon">└</span></button>
            <button disabled onclick="run('edge', 'Y-')"><span class="icon">┴</span></button>
            <button disabled onclick="run('corner', 'BR')"><span class="icon">┘</span></button>
            <button disabled class="btn-shape" onclick="run('pocket', 'circle')"><i class="fa fa-circle-o"></i>
                Hole</button>
        </div>
    </div>

    <!-- Libraries -->
    <script src="vis-graph3d.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="gcode-generator.js"></script>
    <script src="modal-manager.js"></script>
    <script src="index.js"></script>
</body>

</html>